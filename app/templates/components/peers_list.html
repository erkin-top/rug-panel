{% if success %}
<div class="alert alert-success alert-dismissible">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
        <polyline points="22 4 12 14.01 9 11.01"/>
    </svg>
    {{ success }}
</div>
{% endif %}

{% if peers %}
<div class="peers-grid">
    {% for item in peers %}
    {% set peer = item.peer %}
    {% set status = item.status %}
    {% set encoded_key = peer.PublicKey | urlencode_full %}
    <div class="peer-card {% if not peer.get('_enabled', True) %}disabled{% endif %}{% if status.get('is_online') %} online{% endif %}">
        <div class="peer-header">
            <div class="peer-status {% if status.get('is_online') %}online{% else %}offline{% endif %}">
                <span class="status-dot"></span>
                {% if status.get('is_online') %}{{ t.peer.status_online }}{% else %}{{ t.peer.status_offline }}{% endif %}
            </div>
            
            <div class="peer-actions">
                <button class="btn-icon" title="{{ t.peer.qr_code }}"
                        hx-get="/peers/qr?key={{ encoded_key }}"
                        hx-target="#modal-container"
                        hx-swap="innerHTML">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                        <rect x="14" y="14" width="3" height="3"/>
                        <rect x="18" y="14" width="3" height="3"/>
                        <rect x="14" y="18" width="3" height="3"/>
                        <rect x="18" y="18" width="3" height="3"/>
                    </svg>
                </button>
                
                <button class="btn-icon" title="{{ t.peer.edit }}"
                        hx-get="/peers/edit?key={{ encoded_key }}"
                        hx-target="#modal-container"
                        hx-swap="innerHTML">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                </button>
                
                <button class="btn-icon" title="{% if peer.get('_enabled', True) %}{{ t.peer.disable }}{% else %}{{ t.peer.enable }}{% endif %}"
                        hx-post="/peers/toggle?key={{ encoded_key }}"
                        hx-target="#peers-container"
                        hx-swap="innerHTML">
                    {% if peer.get('_enabled', True) %}
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="5" width="22" height="14" rx="7" ry="7"/>
                        <circle cx="16" cy="12" r="3"/>
                    </svg>
                    {% else %}
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="5" width="22" height="14" rx="7" ry="7"/>
                        <circle cx="8" cy="12" r="3"/>
                    </svg>
                    {% endif %}
                </button>
                
                <button class="btn-icon danger" title="{{ t.peer.delete }}"
                        onclick="showConfirmModal({
                            title: '{{ t.peer_delete.title }}',
                            message: '{{ t.peer_delete.message }}'.replace('{name}', '{{ peer.get('_name', t.peer_delete.no_name) }}'),
                            warning: '{{ t.peer_delete.warning }}',
                            confirmText: '{{ t.peer_delete.button_confirm }}',
                            actionType: 'danger',
                            hxMethod: 'delete',
                            hxUrl: '/peers/delete?key={{ encoded_key }}',
                            hxTarget: '#peers-container',
                            hxSwap: 'innerHTML'
                        })">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        <line x1="10" y1="11" x2="10" y2="17"/>
                        <line x1="14" y1="11" x2="14" y2="17"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="peer-body">
            <h3 class="peer-name">{{ peer.get('_name', t.peer.no_name) }}</h3>
            
            <div class="peer-info">
                <div class="info-row">
                    <span class="info-label">{{ t.peer.ip_address }}:</span>
                    <span class="info-value">{{ peer.get('AllowedIPs', '-') }}</span>
                </div>
                
                {% if status.get('endpoint') %}
                <div class="info-row">
                    <span class="info-label">{{ t.peer.endpoint }}:</span>
                    <span class="info-value">{{ status.endpoint }}</span>
                </div>
                {% endif %}
                
                {% if status.get('latest_handshake') %}
                <div class="info-row">
                    <span class="info-label">Handshake:</span>
                    <span class="info-value">{{ status.latest_handshake.strftime('%d.%m.%Y %H:%M') if status.latest_handshake else '-' }}</span>
                </div>
                {% endif %}
                
                {% if status.get('transfer_rx') or status.get('transfer_tx') %}
                <div class="info-row">
                    <span class="info-label">{{ t.peer_delete.traffic }}:</span>
                    <span class="info-value">
                        ↓ {{ "%.2f"|format(status.transfer_rx / 1024 / 1024) }} MB / 
                        ↑ {{ "%.2f"|format(status.transfer_tx / 1024 / 1024) }} MB
                    </span>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="peer-footer">
            <code class="peer-key" title="{{ peer.PublicKey }}">
                {{ peer.PublicKey[:20] }}...
            </code>
            
            {% if peer.get('_created') %}
            <span class="peer-created">
                {{ peer.get('_created', '')[:10] }}
            </span>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-state">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <line x1="17" y1="11" x2="23" y2="11"/>
    </svg>
    <h3>{{ t.dashboard.no_clients }}</h3>
    <p>{{ t.dashboard.no_clients_hint }}</p>
    <button class="btn btn-primary"
            hx-get="/peers/add-form"
            hx-target="#modal-container"
            hx-swap="innerHTML">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        {{ t.dashboard.add_client }}
    </button>
</div>
{% endif %}
