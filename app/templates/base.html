<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ app_name }}{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{{ favicon_path }}">
    
    <!-- HTMX -->
    <script src="{{ htmx_src }}"></script>
    
    <!-- Стили -->
    <link rel="stylesheet" href="/static/style.css?v={{ static_version }}">
    
    {% block head %}{% endblock %}
</head>
<body>
    {% if user %}
    <!-- Навигация -->
    <nav class="navbar">
        <div class="nav-brand">
            <img class="nav-logo" src="{{ favicon_path }}" alt="{{ app_name }}">
            <span>{{ app_name }}</span>
        </div>
        
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        
        <div class="nav-links">
            <a href="/" class="nav-link {% if request.url.path == '/' %}active{% endif %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                {{ t.nav.clients }}
            </a>
            {% if user.is_admin %}
            <a href="/server/settings" class="nav-link {% if '/server' in request.url.path %}active{% endif %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="2" width="20" height="8" rx="2" ry="2"/>
                    <rect x="2" y="14" width="20" height="8" rx="2" ry="2"/>
                    <line x1="6" y1="6" x2="6.01" y2="6"/>
                    <line x1="6" y1="18" x2="6.01" y2="18"/>
                </svg>
                {{ t.nav.server }}
            </a>
            <a href="/users" class="nav-link {% if request.url.path == '/users' %}active{% endif %}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                {{ t.nav.users }}
            </a>
            {% endif %}
        </div>
        
        <div class="nav-user">
            <div class="user-dropdown">
                <button class="user-dropdown-toggle" onclick="toggleUserMenu(this)">
                    <span class="user-avatar-sm">{{ user.username[0].upper() }}</span>
                    <span class="user-name">{{ user.username }}</span>
                    <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </button>
                <div class="user-dropdown-menu">
                    <a href="/profile" class="dropdown-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        {{ t.nav.profile }}
                    </a>
                    <a href="#" class="dropdown-item" onclick="openPasswordModal(); return false;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                        {{ t.nav.change_password }}
                    </a>
                    <div class="dropdown-divider"></div>
                    <a href="/logout" class="dropdown-item dropdown-item-danger">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16 17 21 12 16 7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                        {{ t.nav.logout }}
                    </a>
                </div>
            </div>
        </div>
    </nav>
    {% endif %}
    
    <main class="main-content">
        {% block content %}{% endblock %}
    </main>
    
    <!-- Footer -->
    {% if user %}
    <footer class="app-footer">
        <div class="footer-content">
            <p>
                © 2026 <a href="https://github.com/erkin-top/rug-panel" target="_blank" rel="noopener noreferrer">Rug-Panel</a> by <a href="https://erkin.top" target="_blank" rel="noopener noreferrer">Erkin</a>. 
                Powered by Open Source.
            </p>
        </div>
    </footer>
    {% endif %}
    
    <!-- Toast уведомления -->
    <div id="toast-container"></div>
    
    <script>
        // ==================== CYBERPUNK EFFECTS ====================
        
        // Typewriter effect
        function initTypewriter() {
            const elements = document.querySelectorAll('.header-title p, .page-header p');
            elements.forEach((el, index) => {
                if (el.classList.contains('typewriter-init')) return;
                
                const text = el.textContent;
                el.textContent = '';
                el.classList.add('typewriter');
                el.classList.add('typewriter-init');
                
                let i = 0;
                const speed = 50;
                const delay = index * 500; // Stagger multiple elements
                
                setTimeout(() => {
                    const typing = setInterval(() => {
                        if (i < text.length) {
                            el.textContent += text.charAt(i);
                            i++;
                        } else {
                            clearInterval(typing);
                            el.classList.add('typed');
                        }
                    }, speed);
                }, delay);
            });
        }
        
        // Circuit Lines Background Effect
        function initCircuitLines() {
            // Check if user prefers reduced motion
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                return;
            }
            
            const canvas = document.createElement('canvas');
            canvas.id = 'particles-canvas';
            document.body.insertBefore(canvas, document.body.firstChild);
            
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const lines = [];
            const lineCount = 12;
            
            class CircuitLine {
                constructor() {
                    this.reset();
                }
                
                reset() {
                    this.horizontal = Math.random() > 0.5;
                    
                    if (this.horizontal) {
                        this.x = -100;
                        this.y = Math.random() * canvas.height;
                        this.length = 50 + Math.random() * 150;
                        this.speed = 0.3 + Math.random() * 0.8;
                    } else {
                        this.x = Math.random() * canvas.width;
                        this.y = -100;
                        this.length = 50 + Math.random() * 150;
                        this.speed = 0.3 + Math.random() * 0.8;
                    }
                    
                    this.opacity = 0.15 + Math.random() * 0.25;
                    const colors = ['#00d4ff', '#b537f2', '#00ff88'];
                    this.color = colors[Math.floor(Math.random() * colors.length)];
                    this.pulseOffset = Math.random() * Math.PI * 2;
                }
                
                update() {
                    if (this.horizontal) {
                        this.x += this.speed;
                        if (this.x > canvas.width + 100) this.reset();
                    } else {
                        this.y += this.speed;
                        if (this.y > canvas.height + 100) this.reset();
                    }
                }
                
                draw(time) {
                    const pulse = Math.sin(time * 0.002 + this.pulseOffset) * 0.15 + 0.85;
                    
                    ctx.save();
                    ctx.globalAlpha = this.opacity * pulse;
                    ctx.strokeStyle = this.color;
                    ctx.lineWidth = 1;
                    ctx.shadowBlur = 8;
                    ctx.shadowColor = this.color;
                    
                    ctx.beginPath();
                    if (this.horizontal) {
                        ctx.moveTo(this.x, this.y);
                        ctx.lineTo(this.x + this.length, this.y);
                    } else {
                        ctx.moveTo(this.x, this.y);
                        ctx.lineTo(this.x, this.y + this.length);
                    }
                    ctx.stroke();
                    
                    // Dot at end
                    ctx.fillStyle = this.color;
                    ctx.shadowBlur = 12;
                    if (this.horizontal) {
                        ctx.fillRect(this.x + this.length - 2, this.y - 1, 3, 3);
                    } else {
                        ctx.fillRect(this.x - 1, this.y + this.length - 2, 3, 3);
                    }
                    
                    ctx.restore();
                }
            }
            
            for (let i = 0; i < lineCount; i++) {
                lines.push(new CircuitLine());
            }
            
            let startTime = Date.now();
            
            function animate() {
                const currentTime = Date.now() - startTime;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                lines.forEach(line => {
                    line.update();
                    line.draw(currentTime);
                });
                
                requestAnimationFrame(animate);
            }
            
            animate();
            
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }
        
        // Enhanced modal animations
        function enhanceModals() {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.classList && node.classList.contains('modal-overlay')) {
                            const modal = node.querySelector('.modal');
                            if (modal) {
                                modal.classList.add('glitch-in');
                            }
                        }
                    });
                });
            });
            
            observer.observe(document.body, { childList: true, subtree: true });
        }
        
        // Initialize all effects on page load
        document.addEventListener('DOMContentLoaded', () => {
            initTypewriter();
            initCircuitLines();
            enhanceModals();
        });
        
        // Re-initialize effects on HTMX swaps
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            setTimeout(() => {
                initTypewriter();
            }, 50);
        });
        
        // ==================== ORIGINAL SCRIPTS ====================
        
        // HTMX конфигурация
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            // Автоскрытие уведомлений
            const alerts = evt.detail.target.querySelectorAll('.alert-dismissible');
            alerts.forEach(alert => {
                setTimeout(() => alert.remove(), 5000);
            });
        });
        
        // Подтверждение опасных действий
        document.body.addEventListener('htmx:confirm', function(evt) {
            if (evt.detail.elt.hasAttribute('data-confirm')) {
                evt.preventDefault();
                if (confirm(evt.detail.elt.getAttribute('data-confirm'))) {
                    evt.detail.issueRequest();
                }
            }
        });
        
        // ==================== Modals (shared) ====================
        function closeModal() {
            const container = document.getElementById('modal-container');
            if (container) {
                container.innerHTML = '';
            }
            // На всякий случай закрываем любые overlay, созданные напрямую в body
            document.querySelectorAll('body > .modal-overlay').forEach(el => el.remove());
        }

        function closeModalOnOverlay(event) {
            if (event.target && event.target.classList && event.target.classList.contains('modal-overlay')) {
                closeModal();
            }
        }

        // Закрытие модалки по клику на фон
        document.addEventListener('click', function(e) {
            if (e.target && e.target.classList && e.target.classList.contains('modal-overlay')) {
                closeModalOnOverlay(e);
            }
        });

        // Закрытие модалки по Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const hasModal = document.querySelector('.modal-overlay');
                if (hasModal) closeModal();
            }
        });

        // ==================== Mobile Menu ====================
        function toggleMobileMenu() {
            const navLinks = document.querySelector('.nav-links');
            navLinks.classList.toggle('active');
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const navLinks = document.querySelector('.nav-links');
            const toggle = document.querySelector('.mobile-menu-toggle');
            
            if (navLinks && navLinks.classList.contains('active') && 
                !navLinks.contains(event.target) && 
                !toggle.contains(event.target)) {
                navLinks.classList.remove('active');
            }
        });

        // User dropdown menu
        function toggleUserMenu(btn) {
            const menu = btn.nextElementSibling;
            const isOpen = menu.classList.contains('show');
            
            // Close all dropdowns
            document.querySelectorAll('.user-dropdown-menu.show').forEach(m => m.classList.remove('show'));
            document.querySelectorAll('.user-dropdown-toggle.active').forEach(b => b.classList.remove('active'));
            
            if (!isOpen) {
                menu.classList.add('show');
                btn.classList.add('active');
            }
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.user-dropdown')) {
                document.querySelectorAll('.user-dropdown-menu.show').forEach(m => m.classList.remove('show'));
                document.querySelectorAll('.user-dropdown-toggle.active').forEach(b => b.classList.remove('active'));
            }
        });
        
        // Password change modal
        function openPasswordModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.onclick = function(e) { if (e.target === this) this.remove(); };
            modal.innerHTML = `
                <div class="modal modal-compact" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h2>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                            {{ t.profile.change_password }}
                        </h2>
                        <button class="btn-close" onclick="this.closest('.modal-overlay').remove()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                    <form id="password-change-form" class="modal-form">
                        <div class="form-group">
                            <label for="current_password">{{ t.profile.current_password }}</label>
                            <input type="password" id="current_password" name="current_password" required 
                                   placeholder="{{ t.profile.current_password_placeholder }}" autocomplete="current-password">
                        </div>
                        <div class="form-group">
                            <label for="new_password">{{ t.profile.new_password }}</label>
                            <input type="password" id="new_password" name="new_password" required 
                                   minlength="6" placeholder="{{ t.profile.new_password_placeholder }}" autocomplete="new-password">
                        </div>
                        <div class="form-group">
                            <label for="confirm_password">{{ t.profile.confirm_password }}</label>
                            <input type="password" id="confirm_password" name="confirm_password" required 
                                   minlength="6" placeholder="{{ t.profile.confirm_password_placeholder }}" autocomplete="new-password">
                        </div>
                        <div id="password-result"></div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                                {{ t.common.cancel }}
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                    <polyline points="17 21 17 13 7 13 7 21"/>
                                    <polyline points="7 3 7 8 15 8"/>
                                </svg>
                                {{ t.profile.button_save_password }}
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Form submit handler
            document.getElementById('password-change-form').onsubmit = async function(e) {
                e.preventDefault();
                const form = e.target;
                const result = document.getElementById('password-result');
                const newPass = form.new_password.value;
                const confirmPass = form.confirm_password.value;
                
                if (newPass !== confirmPass) {
                    result.innerHTML = '<div class="alert alert-error">{{ t.errors.passwords_dont_match }}</div>';
                    return;
                }
                
                try {
                    const response = await fetch('/profile/password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({
                            current_password: form.current_password.value,
                            new_password: newPass,
                            confirm_password: confirmPass
                        })
                    });
                    
                    if (response.ok) {
                        result.innerHTML = '<div class="alert alert-success">{{ t.errors.password_changed }}</div>';
                        setTimeout(() => modal.remove(), 1500);
                    } else {
                        const text = await response.text();
                        result.innerHTML = '<div class="alert alert-error">' + (text || '{{ t.errors.password_change_error }}') + '</div>';
                    }
                } catch (err) {
                    result.innerHTML = '<div class="alert alert-error">{{ t.errors.password_change_error }}</div>';
                }
            };
            
            // Close dropdown
            document.querySelectorAll('.user-dropdown-menu.show').forEach(m => m.classList.remove('show'));
        }
    </script>
    
    <script>
        // Универсальная функция для показа модального окна подтверждения
        window.showConfirmModal = function(options) {
            const {
                title = '{{ t.modal.confirm_title }}',
                message = '{{ t.modal.confirm_message }}',
                warning = null,
                confirmText = '{{ t.modal.confirm_button }}',
                actionType = 'danger', // danger, warning, success, primary
                onConfirm = null,
                hxMethod = null, // 'delete', 'post', 'put'
                hxUrl = null,
                hxTarget = null,
                hxSwap = 'innerHTML'
            } = options;
            
            // Удаляем предыдущее модальное окно если есть
            const existingModal = document.getElementById('confirm-modal-overlay');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Создаём модальное окно
            const modal = document.createElement('div');
            modal.id = 'confirm-modal-overlay';
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal confirm-modal">
                    <div class="modal-header">
                        <h2>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                <line x1="12" y1="9" x2="12" y2="13"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                            ${title}
                        </h2>
                        <button class="btn-close" onclick="closeConfirmModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="modal-body">
                        <div class="confirm-message">
                            <p>${message}</p>
                            ${warning ? `
                                <div class="confirm-warning">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                        <line x1="12" y1="9" x2="12" y2="13"/>
                                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                                    </svg>
                                    <span>${warning}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="closeConfirmModal()">
                            {{ t.modal.cancel }}
                        </button>
                        <button type="button" class="btn btn-${actionType}" id="confirm-action-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            ${confirmText}
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Обработчик подтверждения
            const confirmBtn = document.getElementById('confirm-action-btn');
            confirmBtn.onclick = function() {
                if (onConfirm && typeof onConfirm === 'function') {
                    onConfirm();
                } else if (hxMethod && hxUrl) {
                    // HTMX запрос
                    htmx.ajax(hxMethod.toUpperCase(), hxUrl, {
                        target: hxTarget || 'body',
                        swap: hxSwap
                    });
                }
                closeConfirmModal();
            };
            
            // Закрытие по клику вне модального окна
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeConfirmModal();
                }
            });
            
            // Закрытие по ESC
            const escHandler = function(e) {
                if (e.key === 'Escape') {
                    closeConfirmModal();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        };
        
        window.closeConfirmModal = function() {
            const modal = document.getElementById('confirm-modal-overlay');
            if (modal) {
                modal.remove();
            }
        };
    </script>
    
    <div id="modal-container"></div>
    
    {% block scripts %}{% endblock %}
</body>
</html>
