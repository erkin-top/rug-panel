# Документация по системе переводов Rug-Panel

## Обзор

В проект Rug-Panel успешно интегрирована полноценная система многоязычности (i18n - internationalization), поддерживающая русский и английский языки интерфейса.

## Архитектура

### Структура файлов

```
app/
├── languages/          # Языковые пакеты
│   ├── ru.json        # Русский язык
│   └── en.json        # Английский язык
├── i18n.py            # Модуль интернационализации
├── config.py          # Обновлён: добавлена LANGUAGE
└── dependencies.py    # Обновлён: интеграция переводов в шаблоны
```

### Модуль i18n.py

**Ключевые возможности:**
- **Singleton pattern** с thread-safe инициализацией
- **LRU кэширование** загруженных языков (maxsize=10)
- **Lazy loading** языковых файлов
- **Fallback на русский** если язык не найден
- **Nested keys** поддержка (например, `nav.clients`)

**Основные функции:**
```python
from app.i18n import get_i18n, t, get_translations

# Получение singleton экземпляра
i18n = get_i18n()

# Быстрый доступ к переводам
translated_text = t("nav.clients")  # "Клиенты" или "Clients"

# Получение всех переводов для шаблонов
translations = get_translations()
```

### Структура языковых файлов (ru.json, en.json)

Языковые файлы организованы логически по разделам:

```json
{
  "app_name": "Rug-Panel",
  "app_description": "...",
  
  "nav": { ... },           // Навигация
  "login": { ... },         // Страница входа
  "dashboard": { ... },     // Дашборд
  "peer": { ... },          // Карточки клиентов
  "peer_form": { ... },     // Формы клиентов
  "peer_delete": { ... },   // Удаление клиентов
  "server": { ... },        // Настройки сервера
  "profile": { ... },       // Профиль пользователя
  "users": { ... },         // Управление пользователями
  "common": { ... },        // Общие элементы
  "errors": { ... },        // Сообщения об ошибках
  "time": { ... }           // Временные метки
}
```

## Конфигурация

### Переменная окружения LANGUAGE

Добавлена в `app/config.py`:
```python
# ==================== Язык интерфейса ====================
# Поддерживаемые языки: ru (русский), en (английский)
LANGUAGE = os.getenv("LANGUAGE", "ru")
```

### .env файл

```env
# Язык интерфейса (ru - русский, en - английский)
LANGUAGE=ru
```

### .env.example

Обновлён с документацией по новой переменной.

## Использование в шаблонах

### Глобальные переменные Jinja2

В `app/dependencies.py` автоматически доступны:
```python
templates.env.globals["t"] = get_translations()  # Словарь переводов
templates.env.globals["lang"] = LANGUAGE         # Код языка
```

### Примеры использования в шаблонах

**base.html:**
```html
<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <title>{{ t.login.title }} | {{ app_name }}</title>
</head>
```

**Навигация:**
```html
<a href="/">{{ t.nav.clients }}</a>
<a href="/server/settings">{{ t.nav.server }}</a>
<a href="/users">{{ t.nav.users }}</a>
```

**Формы:**
```html
<label for="name">{{ t.peer_form.name }} *</label>
<input type="text" id="name" name="name" 
       placeholder="{{ t.peer_form.name_placeholder }}" required>
<small>{{ t.peer_form.name_hint }}</small>
```

**Кнопки:**
```html
<button class="btn btn-primary">{{ t.common.save }}</button>
<button class="btn btn-outline">{{ t.common.cancel }}</button>
```

## Обновлённые шаблоны

### Основные шаблоны
- ✅ `base.html` - базовый layout, навигация
- ✅ `login.html` - страница входа
- ✅ `dashboard.html` - главная страница

### Компоненты
- ✅ `peers_list.html` - список клиентов
- ✅ `peer_form.html` - форма создания клиента

### Частично обновлённые
- ⚠️ `server_settings.html` - использует старые русские тексты
- ⚠️ `users.html` - использует старые русские тексты
- ⚠️ `profile.html` - использует старые русские тексты

## Тестирование

### Тестирование с Playwright

Протестированы оба языка:

**Русский интерфейс (LANGUAGE=ru):**
- ✅ Страница входа
- ✅ Навигация
- ✅ Dashboard с статистикой
- ✅ Модальное окно создания клиента
- ✅ Карточки клиентов

**Английский интерфейс (LANGUAGE=en):**
- ✅ Login page: "Username", "Password", "Sign In"
- ✅ Navigation: "Clients", "Server", "Users"
- ✅ Dashboard: "VPN Clients", "Total", "Online", "Offline"
- ✅ Modal form: "New Client", "Client Name", "Create", "Cancel"
- ✅ Peer cards: "IP Address", "QR Code", "Edit", "Disable"

### Скриншоты

Сохранены в `.playwright-mcp/`:
- `english-interface-dashboard.png` - дашборд на английском
- `english-interface-modal.png` - модальное окно на английском

## Оптимизации

### Производительность

1. **LRU кэш языков** - загруженные языки кэшируются
2. **Singleton pattern** - один экземпляр I18n на всё приложение
3. **Thread-safe** - безопасная работа в многопоточной среде
4. **Lazy loading** - языки загружаются по требованию

### Память

- Кэш ограничен 10 языками (maxsize=10)
- Файлы JSON компактны (~15 KB на язык)
- Переводы загружаются один раз при старте

## Переключение языка

### Для разработки

```bash
# Установить английский
$env:LANGUAGE="en"
python run.py

# Установить русский
$env:LANGUAGE="ru"
python run.py
```

### Для продакшна

Изменить в `.env`:
```env
LANGUAGE=en
```

И перезапустить сервер:
```bash
docker-compose restart
```

## Добавление нового языка

1. Создать файл `app/languages/fr.json` (например, для французского)
2. Скопировать структуру из `en.json` или `ru.json`
3. Перевести все строки
4. Установить `LANGUAGE=fr` в `.env`
5. Перезапустить приложение

Модуль i18n автоматически обнаружит новый язык.

## Добавление новых переводов

1. Добавить ключ в `ru.json`:
```json
{
  "settings": {
    "theme": "Тема оформления"
  }
}
```

2. Добавить соответствующий перевод в `en.json`:
```json
{
  "settings": {
    "theme": "UI Theme"
  }
}
```

3. Использовать в шаблоне:
```html
<label>{{ t.settings.theme }}</label>
```

## Известные ограничения

1. **Требуется перезапуск** - изменение языка требует перезапуска сервера
2. **Статические тексты** - некоторые старые шаблоны ещё содержат захардкоженные русские тексты
3. **Серверные сообщения** - сообщения об ошибках в Python коде пока на русском

## Roadmap

### Краткосрочные улучшения
- [ ] Обновить оставшиеся шаблоны (server_settings, users, profile)
- [ ] Перевести серверные сообщения об ошибках
- [ ] Добавить переключатель языка в UI

### Долгосрочные улучшения
- [ ] Динамическое переключение языка без перезапуска
- [ ] Добавить больше языков (немецкий, французский, испанский)
- [ ] Форматирование дат/чисел с учётом локали
- [ ] Pluralization support (1 клиент / 2 клиента / 5 клиентов)

## Заключение

Система переводов полностью функциональна и протестирована. Панель поддерживает два языка (русский и английский) с возможностью лёгкого расширения. Основные компоненты интерфейса переведены и корректно отображаются на обоих языках.

**Статус:** ✅ Готово к использованию  
**Дата:** 03 января 2026  
**Версия:** 1.4.3
